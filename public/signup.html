<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Signup</title>
    <link rel="stylesheet" href="./css/styles.css" />
  </head>
  <body>
    <div class="auth-container">
      <h2 id="formTitle">Signup</h2>
      <form id="signupForm">
        <input type="text" id="name" placeholder="Name" required />
        <span class="error-message" id="nameError"></span>

        <input type="email" id="email" placeholder="Email" required />
        <span class="error-message" id="emailError"></span>

        <input type="password" id="password" placeholder="Password" required />
        <span class="error-message" id="passwordError"></span>

        <input type="text" id="phone" placeholder="Phone Number" required />
        <span class="error-message" id="phoneError"></span>

        <select id="gender" required>
          <option value="">Select Gender</option>
          <option value="MALE">Male</option>
          <option value="FEMALE">Female</option>
        </select>
        <span class="error-message" id="genderError"></span>

        <input type="text" id="country" placeholder="Country" required />
        <span class="error-message" id="countryError"></span>

        <input
          type="text"
          id="specialization"
          placeholder="Specialization"
          required
        />
        <span class="error-message" id="specializationError"></span>

        <select id="experienceLevel" required>
          <option value="">Select Experience Level</option>
          <option value="BEGINNER">مبتدئ</option>
          <option value="INTERMEDIATE">متوسط</option>
          <option value="EXPERT">خبير</option>
        </select>
        <span class="error-message" id="experienceLevelError"></span>

        <textarea id="bio" placeholder="Bio (Optional)"></textarea>
        <span class="error-message" id="bioError"></span>

        <button id="submitButton" type="submit">Signup</button>
      </form>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const fields = [
          'name',
          'email',
          'phone',
          'gender',
          'country',
          'specialization',
          'experienceLevel',
          'bio',
        ];

        fields.forEach((field) => {
          document.getElementById(field).value = urlParams.get(field) || '';
        });

        if (urlParams.has('email')) {
          document.getElementById('formTitle').textContent =
            'Complete Registration';
          document.getElementById('password').style.display = 'none';
          document.getElementById('submitButton').textContent =
            'Complete Registration';
        }

        document
          .getElementById('submitButton')
          .addEventListener('click', async (e) => {
            e.preventDefault();
            console.log('Submitting...'); // Debugging

            let valid = true;
            const errorMessages = {
              name: 'Name is required',
              email: 'Valid email is required',
              phone: 'Phone number is required',
              gender: 'Please select a gender',
              country: 'Country is required',
              specialization: 'Specialization is required',
              experienceLevel: 'Please select experience level',
            };

            fields.forEach((field) => {
              const input = document.getElementById(field);
              const errorElement = document.getElementById(field + 'Error');

              if (!input.value) {
                errorElement.textContent = errorMessages[field] || '';
                valid = false;
              } else {
                errorElement.textContent = '';
              }
            });

            if (!valid) {
              console.log('Form validation failed');
              return;
            }

            const formData = fields.reduce((data, field) => {
              data[field] = document.getElementById(field).value;
              return data;
            }, {});

            let res;
            try {
              if (urlParams.has('email')) {
                const token =
                  document.cookie
                    .split('; ')
                    .find((row) => row.startsWith('access_token='))
                    ?.split('=')[1] || null;
                console.log(token);

                res = await fetch('/auth/complete-registration', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`,
                  },
                  body: JSON.stringify(formData),
                });
              } else {
                formData.password = document.getElementById('password').value;
                res = await fetch('/auth/register', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(formData),
                });
              }

              const data = await res.json();
              console.log('Response:', data); // Debugging

              if (res.ok) {
                localStorage.setItem('token', data.access_token);
                alert('Signup successful! Redirecting to login...');
                window.location.href = '/chats.html';
              } else {
                alert(data.message || 'Signup failed. Please try again.');
              }
            } catch (error) {
              console.error('Error submitting form:', error);
              alert('Network error. Please try again later.');
            }
          });
      });
    </script>
  </body>
</html>
